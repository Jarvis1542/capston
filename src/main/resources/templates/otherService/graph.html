<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/layout :: head"/>
<body>
<header th:replace="layout/layout :: header"/>
<!-- bradcam_area  -->
<div class="bradcam_area hp_bg_06">
    <div class="container">
        <div class="row">
            <div class="col-xl-12">
                <div class="bradcam_text">
                    <h3>GRAPH ROOM</h3>
                </div>
            </div>
        </div>
    </div>
</div>

<div>
    <div class="form_box_center">
        <div class="default-select" id="default-select1">
            <select style="display: none;" name="year" id="year">
                <option>년</option>
                <option value="2020">2020</option>
                <option value="2019">2019</option>
                <option value="2018">2018</option>
            </select>
            <div class="nice-select" tabindex="0"><span class="current">년</span>
                <ul class="list">
                    <li class="option selected focus">년</li>
                    <li data-value="2020" class="option">2020</li>
                    <li data-value="2019" class="option">2019</li>
                    <li data-value="2018" class="option">2018</li>
                </ul>
            </div>
        </div>
        <div class="default-select" id="default-select2">
            <select style="display: none;" name="month" id="month">
                <option>월</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
            </select>
            <div class="nice-select" tabindex="0"><span class="current">월</span>
                <ul class="list">
                    <li class="option selected focus">월</li>
                    <li data-value="1" class="option">1</li>
                    <li data-value="2" class="option">2</li>
                    <li data-value="3" class="option">3</li>
                    <li data-value="4" class="option">4</li>
                    <li data-value="5" class="option">5</li>
                    <li data-value="6" class="option">6</li>
                    <li data-value="7" class="option">7</li>
                    <li data-value="8" class="option">8</li>
                    <li data-value="9" class="option">9</li>
                    <li data-value="10" class="option">10</li>
                    <li data-value="11" class="option">11</li>
                    <li data-value="12" class="option">12</li>
                </ul>
            </div>
        </div>
        <div class="default-select" id="default-select3">
            <select style="display: none;" name="week" id="week">
                <option>월</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
            <div class="nice-select" tabindex="0"><span class="current">주간</span>
                <ul class="list">
                    <li class="option selected focus">주간</li>
                    <li data-value="1" class="option">1</li>
                    <li data-value="2" class="option">2</li>
                    <li data-value="3" class="option">3</li>
                    <li data-value="4" class="option">4</li>
                    <li data-value="5" class="option">5</li>
                </ul>
            </div>
        </div>
        <button href="#" class="genric-btn success-border year_button">년도 조회</button>
    </div>
</div>

<div style="width:80%; height: 100%; border: solid 1px black; margin-left: 10%; margin-top:30px;" class="chart1">
    <canvas id="myChart"></canvas>
</div>

<hr>

<div style="width:80%; height: 100%; border: solid 1px black; margin-left: 10%; margin-top:30px;" class="chart2">
    <canvas id="myChart2"></canvas>
</div>
<hr>

<div style="width:80%; height: 100%; border: solid 1px black; margin-left: 10%; margin-top:30px;" class="chart3">
    <canvas id="myChart3"></canvas>
</div>


<footer th:replace="layout/layout :: footer"/>
</body>
<script th:replace="layout/layout :: script"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>

<script>


    $(".year_button").click(function() {
        if ($("#year option:selected").attr("value") != undefined && $("#month option:selected").attr("value") != undefined &&
            $("#week option:selected").attr("value") != undefined) {
            $(".chart1").css({"display":"none"});
            $(".chart2").css({"display":"none"});
            $(".chart3").css({"display":"block"});
        } else if ($("#year option:selected").attr("value") != undefined && $("#month option:selected").attr("value") != undefined) {
            $(".chart1").css({"display":"none"});
            $(".chart2").css({"display":"block"});
            $(".chart3").css({"display":"none"});
        } else if ($("#year option:selected").attr("value") != undefined) {
            $(".chart1").css({"display":"block"});
            $(".chart2").css({"display":"none"});
            $(".chart3").css({"display":"none"});
        }

    });

    var f_day, l_day;
    var date, year_date, month_date;
    var week_52 = [], week_match = [], cnt_month = [], cnt = 0;
    var year_arr = [], month_arr = [], week_arr = [];
    var year, month, result;


    data_func(2020,1);

    function addDays(date_input, days_input) {
        result = new Date(date_input);
        result.setDate(result.getDate() + days_input);
        week_52[cnt] = result;
        cnt++;
        return result;
    }

    function first_day(year_input, month_input) {
        console.log("year_input : " + year_input);
        console.log("month_input : " + month_input);
        year = year_input;
        month = month_input;
        date = new Date(year, month, 1);
        console.log("first date : " + date);
        f_day = date;
    }

    function last_day(year_input, month_input) {
        console.log("year_input : " + year_input);
        console.log("month_input : " + month_input);
        year = year_input;
        month = month_input;
        date = new Date(year, month, 0);
        console.log("last date : " + date);
        l_day = date;
    }

    function week_first_last(msg) {
        var curr = date; // get current date
        var first = curr.getDate() - curr.getDay(); // First day is the day of the month - the day of the week
        var last = first + 6; // last day is the first day + 6

        var week_first = new Date(curr.setDate(first)).toUTCString();
        var week_last = new Date(curr.setDate(last)).toUTCString();

        for (var k = 0; k <= 11; k++) {
            cnt_month[k] = 0;
        }
        for (var j = 1; j <= 52; j++) {
            week_match[j] = 0;
            week_first = new Date(addDays(week_first, 7));
        }
        for (var m = 0; m < week_52.length; m++) {
            for (var a = 0; a < 12; a++) {
                if (week_52[m].getMonth() + 1 == a + 1) {
                    cnt_month[a] += 1;
                }
            }
        }
        for (var i = 0; i < msg.length; i++) {
            var day = new Date(msg[i].week_FIRST);
            for (var m = 0; m < week_52.length; m++) {
                if (week_52[m].getMonth() + 1 == day.getMonth() + 1 && week_52[m].getDate() == day.getDate() - 1) {
                    week_match[m] += 1;
                }
            }
        }
        console.log("msg : ", msg);
        console.log("week_52 : ", week_52);
        console.log("week_match : ", week_match);
        console.log("cnt_month : ", cnt_month);
    }

    function year_arr_func(msg, year_data) {
        for (var j = 0; j < 12; j++) {
            year_arr[j] = 0;
        }
        for (var i = 0; i < msg.length; i++) {
            year_date = new Date(msg[i].create_date);
            for (var k = 12; k > 1; k--) {
                if (year_date.getMonth() + 1 == k && year_date.getFullYear() == year_data) {
                    year_arr[k - 1] += 1;
                }
            }
        }
        console.log("year_arr : ", year_arr);
    }

    function month_arr_func(msg, year_data, month_data) {
        last_day(year_data, month_data);
        console.log("l day get Date : " + l_day.getDate());
        for (var j = 0; j < l_day.getDate(); j++) {
            month_arr[j] = 0;
        }
        for (var i = 0; i < msg.length; i++) {
            month_date = new Date(msg[i].create_date);
            for (var k = l_day.getDate(); k > 1; k--) {
                if (month_date.getMonth() + 1 == k && month_date.getFullYear() == year_data) {
                    month_arr[k - 1] += 1;
                }
            }
        }
        console.log("month_arr : ", month_arr);
    }

    function year_func() {
            console.log("inner year_func year arr : " + year_arr);
            var ctx = document.getElementById('myChart').getContext('2d');
            var chart = new Chart(ctx, {
                // The type of chart we want to create
                type: 'bar',

                // The data for our dataset
                data: {
                    labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                    datasets: [{
                        label: '2020년 가입자 통계',
                        backgroundColor: 'rgb(62,147,0)',
                        borderColor: 'rgb(64,64,64)',
                        data: [year_arr[0], year_arr[1], year_arr[2], year_arr[3], year_arr[4], year_arr[5], year_arr[6],
                            year_arr[7], year_arr[8], year_arr[9], year_arr[10], year_arr[11]]
                    }]
                },

                options: {}
            });

    }

    var lineChartData = { labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13',
            '14', '15', '16', '17', '18', '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31'], datasets: [] };

    for(var i = 0; i <= 10; i++) {
        lineChartData.datasets.push({
            label: '주간 가입자 통계',
            backgroundColor: 'rgb(255,171,45)',
            borderColor: 'rgb(64,64,64)',
            data: JSON.parse(i)
        });
    }
    console.log("lineChart Data : ", lineChartData);

    function month_func() {
        var ctx2 = document.getElementById('myChart2').getContext('2d');
        var chart2 = new Chart(ctx2, {
            // The type of chart we want to create
            type: 'bar',

            // The data for our dataset
            data: {
                labels: ['일', '월', '화', '수', '목', '금', '토'],
                datasets: [{
                    label: '주간 가입자 통계',
                    backgroundColor: 'rgb(255,171,45)',
                    borderColor: 'rgb(64,64,64)',
                    data: [1, 2, 3]
                }]
            },

            // Configuration options go here
            options: {}
        });
        //chart2.data.datasets.data.push(lineChartData)
        chart2.data.datasets[0].data.push(4);
        console.log("chart2 data : ", chart2.data.datasets);
        chart2.update();
    }

    function week_func() {
        // 일주일 가입자 그래프
        var ctx3 = document.getElementById('myChart3').getContext('2d');
        var chart3 = new Chart(ctx3, {
            // The type of chart we want to create
            type: 'bar',
            // The data for our dataset
            data: {
                labels: ['일', '월', '화', '수', '목', '금', '토'],
                datasets: [{
                    label: '주간 가입자 통계',
                    backgroundColor: 'rgb(255,171,45)',
                    borderColor: 'rgb(64,64,64)',
                    data: [2, 10, 5, 2, 20, 30, 45]
                }]
            },

            // Configuration options go here
            options: {}
        });
    }

    function data_func(year_data, month_data) {
        last_day(year_data, month_data);
        if(month_data == 1) {
            first_day(year_data - 1, 12);
        } else {
            first_day(year_data, month_data-1);
        }
        $.ajax({
            method: "post",
            url: "/rest/GraphList"
        })
        .done(function (msg) {
            year_arr_func(msg, year_data);
            year_func();

            month_arr_func(msg, year_data, month_data);
            month_func();
        }).fail(function (error) {
            alert("에러 : " + error);
        });
        $.ajax({
            method: "post",
            url: "/rest/weekList"
        }).done(function (msg) {
            week_first_last(msg);
        }).fail(function (error) {
            console.log("에러 : ", error);
        });


    }





</script>
</html>